
%% prepare matlab
close all
clear 
clc
tic
%% define system to begin with
% param=[0.6;0.6;0.6;0.6;0.6;0.6;0.6;0.6;0.6;0.6];
% param=[0.2;0.2;0.2;0.2;0.2;0.2;0.2;0.2;0.2;0.2];
% param=[0.3;0.3;0.3;0.3;0.3;0.3;0.3;0.3;0.3;0.3];
% param=[0.4;0.4;0.4;0.4;0.4;0.4;0.4;0.4;0.4;0.4];
param=0.46*ones(10,1);
xGue=[0.1910;0.2732;-0.01;0.1910;0.2732;-0.01;0.1910;0.2732;-0.01;0.1910;0.2732;-0.01;...
    0.1910;0.2732;-0.01;0.1910;0.2732;-0.01;0.1910;0.2732;-0.01;0.1910;0.2732;-0.01;...
    0.1910;0.2732;-0.01;0.1910;0.2732;-0.01];

%% name states and parameters
xNom=VariableVector(xGue,0,[{'E1r'};{'E1i'};{'n1'};{'E2r'};{'E2i'};{'n2'};...
    {'E3r'};{'E3i'};{'n3'};{'E4r'};{'E4i'};{'n4'};{'E5r'};{'E5i'};{'n5'};...
    {'E6r'};{'E6i'};{'n6'};{'E7r'};{'E7i'};{'n7'};{'E8r'};{'E8i'};{'n8'};...
    {'E9r'};{'E9i'};{'n9'};{'E10r'};{'E10i'};{'n10'}]);
alphaNom=VariableVector(param,30,[{'pump1'};{'pump2'};{'pump3'};{'pump4'};...
    {'pump5'};{'pump6'};{'pump7'};{'pump8'};{'pump9'};{'pump10'}]);
p=VariableVector(-0.02,40,{'omega'});

%% define system dynamics
tau=@(x,alpha,p)100/1000;

lasermod=@DDE_10L_symm;

%% collect them in an object 
aDDE_10L=DDE(@(x,xtau,alpha,p)lasermod(x,xtau,alpha,p),tau,xNom,alphaNom,p);

% clear tau
% clear alphaNom
% clear xGue
% clear param
% clear omega
% clear phi

%% construct object ''aDDENLP''

J=@(x)-10*(abs((x(1)+1i*x(2))...
    +(x(4)+1i*x(5))...
    +(x(7)+1i*x(8))...
    +(x(10)+1i*x(11))...
    +(x(13)+1i*x(14))...
    +(x(16)+1i*x(17))...
    +(x(19)+1i*x(20))...
    +(x(22)+1i*x(23))...
    +(x(25)+1i*x(26))...
    +(x(28)+1i*x(29)))^2); %Maximale Intensität (mit p1=p2=p3=p3=0.1)

minDist=0.01;


aDDENLP=DDENLP(J,aDDE_10L,xNom,...
    -Inf(30,1),Inf(30,1),...
    [0;0;0;0;0;0;0;0;0;0]+sqrt(10)*minDist,...
    [Inf;Inf;Inf;0.5;0.5;0.5;0.5;0.5;0.5;0.5]-sqrt(10)*minDist,... %   was klappt:  [Inf;Inf;0.5;0.5;0.5;0.5;0.5;0.5;0.5;0.5]-sqrt(10)*minDist,...klappt!   
    -Inf,Inf);

% clear aDDE_1L
% clear J
% clear xNom

aDDENLP.optionsInitEqCons=optimoptions('fsolve','Algorithm','levenberg-marquardt','MaxIter',10000,'MaxFunEvals',200000,'display','off','TolFun',1e-7,'TolX',1e-7);
aDDENLP.optionsInitOptim=optimoptions('fmincon','Algorithm','active-set','MaxIter',10000,'MaxFunEvals',200000,'display','off');
% aDDENLP.optionsMainOptim=optimoptions('fmincon','Algorithm','active-set','MaxIter',10000,'MaxFunEvals',200000,'display','iter','TolFun',1e-6,'TolX',1e-6);
aDDENLP.optionsMainOptim=optimoptions('fmincon','Algorithm','interior-point','MaxIter',10000,'MaxFunEvals',2000000,'display','iter','TolFun',1e-12,'TolX',1e-12,'ScaleProblem','none');

%active-set
%% initialize steady state constraints
aDDENLP.initializeStSt();


%% add NV Cons
%Hier wird die Symmetrie ausgenutzt. Aus DDE-Biftool sind lediglich die
%Werte für die ersten Constraints bekannt. Die acht weiteren werden draus
%entwickelt (Verschiebung der Relevanten einträge)


%Mod-Fold Punkt (Branch1, Point 41) (Aus DDE-Biftool)
xCrit1=VariableVector([0.140585418448410;0.312014898760553;-0.00944229593410655;...
                       0.228746292350277;0.207054240531333;-0.0104821048739373;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910],0,...
    [{'E1rcrit1'};{'E1icrit1'};{'n1crit1'};{'E2rcrit1'};{'E2icrit1'};{'n2crit1'};{'E3rcrit1'};{'E3icrit1'};{'n3crit1'};{'E4rcrit1'};{'E4icrit1'};{'n4crit1'};{'E5rcrit1'};{'E5icrit1'};{'n5crit1'};{'E6rcrit1'};{'E6icrit1'};{'n6crit1'};{'E7rcrit1'};{'E7icrit1'};{'n7crit1'};{'E8rcrit1'};{'E8icrit1'};{'n8crit1'};{'E9rcrit1'};{'E9icrit1'};{'n9crit1'};{'E10rcrit1'};{'E10icrit1'};{'n10crit1'}]);
alphaCrit1=VariableVector([0.106569402363164;...
                           0.0837163620520477;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000],0,...
    [{'pump1crit1'};{'pump2crit1'};{'pump3crit1'};{'pump4crit1'};{'pump5crit1'};{'pump6crit1'};{'pump7crit1'};{'pump8crit1'};{'pump9crit1'};{'pump10crit1'}]);
pCrit1=VariableVector(-0.0198807084280759,0,{'omegacrit1'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.297440982724301;0.134019045430380;1.39041702484891e-08;...
                                   -0.197381761878576;0.218060427662594;-6.70823777116396e-10;...
                                   -0.258584587236901;0.184434926590457;1.23907878814628e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878864250e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878490176e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878789545e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878840803e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878571971e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907879376285e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907879352292e-09];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch1, Point 97) (Aus DDE-Biftool)
xCrit1=VariableVector([0.219788322349402;0.224719335079797;-0.0103872519200967;...
                       0.132332809676990;0.316271567585108;-0.00944375515214064;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964],0,...
    [{'E1rcrit2'};{'E1icrit2'};{'n1crit2'};{'E2rcrit2'};{'E2icrit2'};{'n2crit2'};{'E3rcrit2'};{'E3icrit2'};{'n3crit2'};{'E4rcrit2'};{'E4icrit2'};{'n4crit2'};{'E5rcrit2'};{'E5icrit2'};{'n5crit2'};{'E6rcrit2'};{'E6icrit2'};{'n6crit2'};{'E7rcrit2'};{'E7icrit2'};{'n7crit2'};{'E8rcrit2'};{'E8icrit2'};{'n8crit2'};{'E9rcrit2'};{'E9icrit2'};{'n9crit2'};{'E10rcrit2'};{'E10icrit2'};{'n10crit2'}]);
alphaCrit1=VariableVector([0.0873921147260768;...
                           0.106985905897547;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000],0,...
    [{'pump1crit2'};{'pump2crit2'};{'pump3crit2'};{'pump4crit2'};{'pump5crit2'};{'pump6crit2'};{'pump7crit2'};{'pump8crit2'};{'pump9crit2'};{'pump10crit2'}]);
pCrit1=VariableVector(-0.0198989010137513,0,{'omegacrit2'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.213808441703883;0.209116857655040;-2.78511050285314e-10;...
                                   -0.300917413009337;0.125908649460655;1.47338649313727e-08;...
                                   -0.261300973928965;0.179557170850122;1.24432490754180e-09;...
                                   -0.261300973928965;0.179557170850122;1.24432490415788e-09;...
                                   -0.261300973928964;0.179557170850121;1.24432489288917e-09;...
                                   -0.261300973928965;0.179557170850122;1.24432490172586e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489674628e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432490185242e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489446833e-09;...
                                   -0.261300973928964;0.179557170850121;1.24432489138154e-09];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch2, Point 41) (Aus Symmetrie)
xCrit1=VariableVector([0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.140585418448410;0.312014898760553;-0.00944229593410655;...
                       0.228746292350277;0.207054240531333;-0.0104821048739373;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910],0,...
    [{'E1rcrit1'};{'E1icrit1'};{'n1crit1'};{'E2rcrit1'};{'E2icrit1'};{'n2crit1'};{'E3rcrit1'};{'E3icrit1'};{'n3crit1'};{'E4rcrit1'};{'E4icrit1'};{'n4crit1'};{'E5rcrit1'};{'E5icrit1'};{'n5crit1'};{'E6rcrit1'};{'E6icrit1'};{'n6crit1'};{'E7rcrit1'};{'E7icrit1'};{'n7crit1'};{'E8rcrit1'};{'E8icrit1'};{'n8crit1'};{'E9rcrit1'};{'E9icrit1'};{'n9crit1'};{'E10rcrit1'};{'E10icrit1'};{'n10crit1'}]);
alphaCrit1=VariableVector([0.100000000000000;...
                           0.100000000000000;...
                           0.106569402363164;...
                           0.0837163620520477;...                      
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000],0,...
    [{'pump1crit1'};{'pump2crit1'};{'pump3crit1'};{'pump4crit1'};{'pump5crit1'};{'pump6crit1'};{'pump7crit1'};{'pump8crit1'};{'pump9crit1'};{'pump10crit1'}]);
pCrit1=VariableVector(-0.0198807084280759,0,{'omegacrit1'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.258584587236901;0.184434926590457;1.23907878814628e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878864250e-09;...
                                   -0.297440982724301;0.134019045430380;1.39041702484891e-08;...
                                   -0.197381761878576;0.218060427662594;-6.70823777116396e-10;...                                 
                                   -0.258584587236902;0.184434926590457;1.23907878490176e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878789545e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878840803e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878571971e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907879376285e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907879352292e-09];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch2, Point 97) (Aus Symmetrie)
xCrit1=VariableVector([0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.219788322349402;0.224719335079797;-0.0103872519200967;...
                       0.132332809676990;0.316271567585108;-0.00944375515214064;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...                      
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964],0,...
    [{'E1rcrit2'};{'E1icrit2'};{'n1crit2'};{'E2rcrit2'};{'E2icrit2'};{'n2crit2'};{'E3rcrit2'};{'E3icrit2'};{'n3crit2'};{'E4rcrit2'};{'E4icrit2'};{'n4crit2'};{'E5rcrit2'};{'E5icrit2'};{'n5crit2'};{'E6rcrit2'};{'E6icrit2'};{'n6crit2'};{'E7rcrit2'};{'E7icrit2'};{'n7crit2'};{'E8rcrit2'};{'E8icrit2'};{'n8crit2'};{'E9rcrit2'};{'E9icrit2'};{'n9crit2'};{'E10rcrit2'};{'E10icrit2'};{'n10crit2'}]);
alphaCrit1=VariableVector([0.100000000000000;...
                           0.100000000000000;...
                           0.0873921147260768;...
                           0.106985905897547;...
                           0.100000000000000;...                          
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000],0,...
    [{'pump1crit2'};{'pump2crit2'};{'pump3crit2'};{'pump4crit2'};{'pump5crit2'};{'pump6crit2'};{'pump7crit2'};{'pump8crit2'};{'pump9crit2'};{'pump10crit2'}]);
pCrit1=VariableVector(-0.0198989010137513,0,{'omegacrit2'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.261300973928965;0.179557170850122;1.24432490415788e-09;...
                                   -0.261300973928964;0.179557170850121;1.24432489288917e-09;...
                                   -0.213808441703883;0.209116857655040;-2.78511050285314e-10;...
                                   -0.300917413009337;0.125908649460655;1.47338649313727e-08;...
                                   -0.261300973928965;0.179557170850122;1.24432490754180e-09;...                                 
                                   -0.261300973928965;0.179557170850122;1.24432490172586e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489674628e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432490185242e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489446833e-09;...
                                   -0.261300973928964;0.179557170850121;1.24432489138154e-09];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch3, Point 41) (Aus Symmetrie)
xCrit1=VariableVector([0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.140585418448410;0.312014898760553;-0.00944229593410655;...
                       0.228746292350277;0.207054240531333;-0.0104821048739373;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910],0,...
    [{'E1rcrit1'};{'E1icrit1'};{'n1crit1'};{'E2rcrit1'};{'E2icrit1'};{'n2crit1'};{'E3rcrit1'};{'E3icrit1'};{'n3crit1'};{'E4rcrit1'};{'E4icrit1'};{'n4crit1'};{'E5rcrit1'};{'E5icrit1'};{'n5crit1'};{'E6rcrit1'};{'E6icrit1'};{'n6crit1'};{'E7rcrit1'};{'E7icrit1'};{'n7crit1'};{'E8rcrit1'};{'E8icrit1'};{'n8crit1'};{'E9rcrit1'};{'E9icrit1'};{'n9crit1'};{'E10rcrit1'};{'E10icrit1'};{'n10crit1'}]);
alphaCrit1=VariableVector([0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.106569402363164;...
                           0.0837163620520477;...                      
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000],0,...
    [{'pump1crit1'};{'pump2crit1'};{'pump3crit1'};{'pump4crit1'};{'pump5crit1'};{'pump6crit1'};{'pump7crit1'};{'pump8crit1'};{'pump9crit1'};{'pump10crit1'}]);
pCrit1=VariableVector(-0.0198807084280759,0,{'omegacrit1'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.258584587236901;0.184434926590457;1.23907878814628e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878864250e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878789545e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878840803e-09;...
                                   -0.297440982724301;0.134019045430380;1.39041702484891e-08;...
                                   -0.197381761878576;0.218060427662594;-6.70823777116396e-10;...                                 
                                   -0.258584587236902;0.184434926590457;1.23907878490176e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878571971e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907879376285e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907879352292e-09];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch3, Point 97) (Aus Symmetrie)
xCrit1=VariableVector([0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.219788322349402;0.224719335079797;-0.0103872519200967;...
                       0.132332809676990;0.316271567585108;-0.00944375515214064;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...                      
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964],0,...
    [{'E1rcrit2'};{'E1icrit2'};{'n1crit2'};{'E2rcrit2'};{'E2icrit2'};{'n2crit2'};{'E3rcrit2'};{'E3icrit2'};{'n3crit2'};{'E4rcrit2'};{'E4icrit2'};{'n4crit2'};{'E5rcrit2'};{'E5icrit2'};{'n5crit2'};{'E6rcrit2'};{'E6icrit2'};{'n6crit2'};{'E7rcrit2'};{'E7icrit2'};{'n7crit2'};{'E8rcrit2'};{'E8icrit2'};{'n8crit2'};{'E9rcrit2'};{'E9icrit2'};{'n9crit2'};{'E10rcrit2'};{'E10icrit2'};{'n10crit2'}]);
alphaCrit1=VariableVector([0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.0873921147260768;...
                           0.106985905897547;...
                           0.100000000000000;...                          
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000],0,...
    [{'pump1crit2'};{'pump2crit2'};{'pump3crit2'};{'pump4crit2'};{'pump5crit2'};{'pump6crit2'};{'pump7crit2'};{'pump8crit2'};{'pump9crit2'};{'pump10crit2'}]);
pCrit1=VariableVector(-0.0198989010137513,0,{'omegacrit2'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.261300973928965;0.179557170850122;1.24432490415788e-09;...
                                   -0.261300973928964;0.179557170850121;1.24432489288917e-09;...
                                   -0.261300973928965;0.179557170850122;1.24432490754180e-09;...                                 
                                   -0.261300973928965;0.179557170850122;1.24432490172586e-09;...
                                   -0.213808441703883;0.209116857655040;-2.78511050285314e-10;...
                                   -0.300917413009337;0.125908649460655;1.47338649313727e-08;...
                                   -0.261300973928964;0.179557170850122;1.24432489674628e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432490185242e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489446833e-09;...
                                   -0.261300973928964;0.179557170850121;1.24432489138154e-09];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch4, Point 41) (Aus Symmetrie)
xCrit1=VariableVector([0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.140585418448410;0.312014898760553;-0.00944229593410655;...
                       0.228746292350277;0.207054240531333;-0.0104821048739373;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910],0,...
    [{'E1rcrit1'};{'E1icrit1'};{'n1crit1'};{'E2rcrit1'};{'E2icrit1'};{'n2crit1'};{'E3rcrit1'};{'E3icrit1'};{'n3crit1'};{'E4rcrit1'};{'E4icrit1'};{'n4crit1'};{'E5rcrit1'};{'E5icrit1'};{'n5crit1'};{'E6rcrit1'};{'E6icrit1'};{'n6crit1'};{'E7rcrit1'};{'E7icrit1'};{'n7crit1'};{'E8rcrit1'};{'E8icrit1'};{'n8crit1'};{'E9rcrit1'};{'E9icrit1'};{'n9crit1'};{'E10rcrit1'};{'E10icrit1'};{'n10crit1'}]);
alphaCrit1=VariableVector([0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.106569402363164;...
                           0.0837163620520477;...                      
                           0.100000000000000;...
                           0.100000000000000],0,...
    [{'pump1crit1'};{'pump2crit1'};{'pump3crit1'};{'pump4crit1'};{'pump5crit1'};{'pump6crit1'};{'pump7crit1'};{'pump8crit1'};{'pump9crit1'};{'pump10crit1'}]);
pCrit1=VariableVector(-0.0198807084280759,0,{'omegacrit1'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.258584587236901;0.184434926590457;1.23907878814628e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878864250e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878789545e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878840803e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878571971e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907879376285e-09;...
                                   -0.297440982724301;0.134019045430380;1.39041702484891e-08;...
                                   -0.197381761878576;0.218060427662594;-6.70823777116396e-10;...                                 
                                   -0.258584587236902;0.184434926590457;1.23907878490176e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907879352292e-09];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch4, Point 97) (Aus Symmetrie)
xCrit1=VariableVector([0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...                      
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.219788322349402;0.224719335079797;-0.0103872519200967;...
                       0.132332809676990;0.316271567585108;-0.00944375515214064;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964],0,...
    [{'E1rcrit2'};{'E1icrit2'};{'n1crit2'};{'E2rcrit2'};{'E2icrit2'};{'n2crit2'};{'E3rcrit2'};{'E3icrit2'};{'n3crit2'};{'E4rcrit2'};{'E4icrit2'};{'n4crit2'};{'E5rcrit2'};{'E5icrit2'};{'n5crit2'};{'E6rcrit2'};{'E6icrit2'};{'n6crit2'};{'E7rcrit2'};{'E7icrit2'};{'n7crit2'};{'E8rcrit2'};{'E8icrit2'};{'n8crit2'};{'E9rcrit2'};{'E9icrit2'};{'n9crit2'};{'E10rcrit2'};{'E10icrit2'};{'n10crit2'}]);
alphaCrit1=VariableVector([0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.0873921147260768;...
                           0.106985905897547;...
                           0.100000000000000;...                          
                           0.100000000000000],0,...
    [{'pump1crit2'};{'pump2crit2'};{'pump3crit2'};{'pump4crit2'};{'pump5crit2'};{'pump6crit2'};{'pump7crit2'};{'pump8crit2'};{'pump9crit2'};{'pump10crit2'}]);
pCrit1=VariableVector(-0.0198989010137513,0,{'omegacrit2'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.261300973928965;0.179557170850122;1.24432490415788e-09;...
                                   -0.261300973928964;0.179557170850121;1.24432489288917e-09;...
                                   -0.261300973928965;0.179557170850122;1.24432490172586e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489674628e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432490185242e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489446833e-09;...
                                   -0.213808441703883;0.209116857655040;-2.78511050285314e-10;...
                                   -0.300917413009337;0.125908649460655;1.47338649313727e-08;...
                                   -0.261300973928965;0.179557170850122;1.24432490754180e-09;...                                 
                                   -0.261300973928964;0.179557170850121;1.24432489138154e-09];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch5, Point 41) (Aus Symmetrie)
xCrit1=VariableVector([0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.193472759923269;0.271256161022037;-0.00991133988943910;...
                       0.140585418448410;0.312014898760553;-0.00944229593410655;...
                       0.228746292350277;0.207054240531333;-0.0104821048739373],0,...
    [{'E1rcrit1'};{'E1icrit1'};{'n1crit1'};{'E2rcrit1'};{'E2icrit1'};{'n2crit1'};{'E3rcrit1'};{'E3icrit1'};{'n3crit1'};{'E4rcrit1'};{'E4icrit1'};{'n4crit1'};{'E5rcrit1'};{'E5icrit1'};{'n5crit1'};{'E6rcrit1'};{'E6icrit1'};{'n6crit1'};{'E7rcrit1'};{'E7icrit1'};{'n7crit1'};{'E8rcrit1'};{'E8icrit1'};{'n8crit1'};{'E9rcrit1'};{'E9icrit1'};{'n9crit1'};{'E10rcrit1'};{'E10icrit1'};{'n10crit1'}]);
alphaCrit1=VariableVector([0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...                      
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.106569402363164;...
                           0.0837163620520477],0,...
    [{'pump1crit1'};{'pump2crit1'};{'pump3crit1'};{'pump4crit1'};{'pump5crit1'};{'pump6crit1'};{'pump7crit1'};{'pump8crit1'};{'pump9crit1'};{'pump10crit1'}]);
pCrit1=VariableVector(-0.0198807084280759,0,{'omegacrit1'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.258584587236901;0.184434926590457;1.23907878814628e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878864250e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878789545e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878840803e-09;...                                 
                                   -0.258584587236902;0.184434926590457;1.23907878490176e-09;...
                                   -0.258584587236902;0.184434926590457;1.23907878789545e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878840803e-09;...
                                   -0.258584587236901;0.184434926590457;1.23907878571971e-09;...
                                   -0.297440982724301;0.134019045430380;1.39041702484891e-08;...
                                   -0.197381761878576;0.218060427662594;-6.70823777116396e-10];
clear alphaCrit1
clear xCrit1
clear pCrit1

%Mod-Fold Punkt (Branch5, Point 97) (Aus Symmetrie)
xCrit1=VariableVector([0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;....
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...                      
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.188719967968016;0.274635378632112;-0.00993647332192964;...
                       0.219788322349402;0.224719335079797;-0.0103872519200967;...
                       0.132332809676990;0.316271567585108;-0.00944375515214064],0,...
    [{'E1rcrit2'};{'E1icrit2'};{'n1crit2'};{'E2rcrit2'};{'E2icrit2'};{'n2crit2'};{'E3rcrit2'};{'E3icrit2'};{'n3crit2'};{'E4rcrit2'};{'E4icrit2'};{'n4crit2'};{'E5rcrit2'};{'E5icrit2'};{'n5crit2'};{'E6rcrit2'};{'E6icrit2'};{'n6crit2'};{'E7rcrit2'};{'E7icrit2'};{'n7crit2'};{'E8rcrit2'};{'E8icrit2'};{'n8crit2'};{'E9rcrit2'};{'E9icrit2'};{'n9crit2'};{'E10rcrit2'};{'E10icrit2'};{'n10crit2'}]);
alphaCrit1=VariableVector([0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...                          
                           0.100000000000000;...
                           0.100000000000000;...
                           0.100000000000000;...
                           0.0873921147260768;...
                           0.106985905897547],0,...
    [{'pump1crit2'};{'pump2crit2'};{'pump3crit2'};{'pump4crit2'};{'pump5crit2'};{'pump6crit2'};{'pump7crit2'};{'pump8crit2'};{'pump9crit2'};{'pump10crit2'}]);
pCrit1=VariableVector(-0.0198989010137513,0,{'omegacrit2'});

aDDENLP.addNVCon('modfold',@Mod_Fold_10L_symm,@NV_Mod_Fold_10L_symm,xCrit1,alphaCrit1,pCrit1);
aDDENLP.NVCon(end).vars.w1.values=[-0.261300973928965;0.179557170850122;1.24432490415788e-09;...
                                   -0.261300973928964;0.179557170850121;1.24432489288917e-09;...
                                   -0.261300973928965;0.179557170850122;1.24432490172586e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489674628e-09;...
                                   -0.261300973928965;0.179557170850122;1.24432490754180e-09;...                                 
                                   -0.261300973928965;0.179557170850122;1.24432490172586e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432489674628e-09;...
                                   -0.261300973928964;0.179557170850122;1.24432490185242e-09;...
                                   -0.213808441703883;0.209116857655040;-2.78511050285314e-10;...
                                   -0.300917413009337;0.125908649460655;1.47338649313727e-08];
clear alphaCrit1
clear xCrit1
clear pCrit1

%% initatialize constraints and prepare optimization

aDDENLP.initNVCons();
aDDENLP.concatConstraints();
aDDENLP.concatInitPoints();


%% run optimization
aDDENLP.maxAllowedRealPart=-1;
aDDENLP.minDist=minDist;


aDDENLP.allNLIneqConstraints(aDDENLP.initVal)
aDDENLP.runOptim;


aDDENLP.optionsMainOptim=optimoptions('fmincon','Algorithm','active-set','MaxIter',10000,'MaxFunEvals',2000000,'display','iter','TolFun',1e-12,'TolX',1e-12,'TolCon',1e-7,'ScaleProblem','none','InitBarrierParam',100000);
aDDENLP.deconstructOptimum();

aDDENLP.aCostFunction=@(x)-0.1*(abs((x(1)+1i*x(2))...
    +(x(4)+1i*x(5))...
    +(x(7)+1i*x(8))...
    +(x(10)+1i*x(11))...
    +(x(13)+1i*x(14))...
    +(x(16)+1i*x(17))...
    +(x(19)+1i*x(20))...
    +(x(22)+1i*x(23))...
    +(x(25)+1i*x(26))...
     +(x(28)+1i*x(29))))^2; %Maximale Intensität (mit p1=p2=p3=p3=0.1)



aDDENLP.concatInitPoints();
aDDENLP.runOptim;

aDDENLP.deconstructOptimum();
toc

alphaCrit=NaN(10);

for ii=1:10
    alphaCrit(:,ii)=aDDENLP.vars.critical(ii).alpha.values;
end

figure(4)
plot(1:10,alphaCrit')


%% check stability

[~]=aDDENLP.checkStabilityPoint('nominal');
% [~]=aDDENLP.checkStabilityPoint('critical');
% 
% [~]=aDDENLP.checkStabilityAtVertices();
% 
% [~]=aDDENLP.checkStabilityAtRandom();

return
%% run simulation

 point=aDDENLP.vars.nominal; 
 
%  history=point.x.values+0.001*randn(30,1);
omega=point.p.values(1);
history=@(t)[];

phi=1.6;

omegaDisturbance=linspace(-0.5*omega,0.5*omega,10)';
absDisturbance=linspace(1,1.3,10)';

for ii = 1:10
    E(ii)=exp(1i*phi*pi)*(point.x.values(ii*3-2)+1i*point.x.values(3*ii-1));
    n(ii)=point.x.values(ii*3);
    history=@(t)[history(t);real(E(ii)*absDisturbance(ii)*exp(+1i*omegaDisturbance(ii)*t));imag(E(ii)*absDisturbance(ii)*exp(+1i*omegaDisturbance(ii)*t));n(ii)+t*0];
end


% for ii=1:10
%    Ai=history(3*(ii-1)+1)+1i*history(3*(ii-1)+2)*exp(1i*0.01*(rand(1)-0.5)*pi);
%    history(3*(ii-1)+1)=real(Ai);
%    history(3*(ii-1)+2)=imag(Ai);
% end
% 
% history=repmat([0;0;(point.x.values(3)+point.x.values(18))/2],10,1)+0.001*randn(30,1);


 options=ddeset('MaxStep',0.01);
 sol=ddesd(aDDENLP,point,history,[0 2],options);
 
 figure(2);clf;
 plot(sol.x,sol.y(1:3:end,:));
 matlab2tikz('10LRot.tex')
 
 
 figure(3);clf;
 A=sol.y(1:3:end,:)+1i*sol.y(2:3:end,:);
 E=A.*repmat(exp(-1i*point.p.values(1)*sol.x*1000),10,1);
 plot(sol.x,real(E))

  matlab2tikz('10LFix.tex')

