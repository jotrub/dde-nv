######################################################################
#
# @path BVPOpt/CreateInstance.txt 
#
# @param  DAESys,
#         anNLP, NLP which contains constraints, cost function 
#                and internal variables of optimization
#         WorkingDir, directory into which files will be written
#                     when compiling and at runtime
#         nodes, number of nodes in multi-shooting procedure,
#         initX0, the initial guess for first point X0 of the trajectory solution
#         initP, the initial guess for period of the trajectory solution 
#         list of compilled objects obtaned from TIDES            
#
# @return  procedure which starts bvpsol
#
# @notes list of compilled objects obtaned from TIDES should
#        contain path to "calltides.o" and corresponding 
#        system file, e.g., "scott.o"
#
# @revision
#   2011-11-12 written by dka
#
######################################################################
  CreateInstance:=proc(anBVPSys::DAESys,
                       anNLP::NLP,
                       WorkingDir::string,
                       nodes::integer,
                       initX0::list(name= EvalsToFloat),
                       initP::EvalsToFloat,                       
                       objNames::list(string))

    local bvpopt, BVPOptInstance, NewValues, NewParsNames, Missing, 
          Obsolete, i1, ParNames, X0; 
    
     #
     # prepare working dir
     # refuse to work if file cwrap_bvpopt1.so already exists
     #
        if Aux:-FileOperations:-fileExists(cat(WorkingDir, "/cwrap_npsol1.so"))
        then
          error(
            "in working dir, %1, a maple wrapper file named "
            "cwrap_npsol1.so already exists", WorkingDir
          );
        end if; 

    
  
     ParNames:=anBVPSys["DynVars"];

    #
    # make sure values for all variables values are given in initial point
    #
      NewParsNames:= map(lhs, initX0); 
      Missing, Obsolete:= Aux:-ListOperations:-getMissingAndObsoleteNames(
        NewParsNames,
        ParNames
      );
      if not
        Missing= {}
      then
        error("assignments in initial point (5th argument) are missing for %1", Missing);
      end if;

    #
    # assign values
    #   
      NewValues:= subs(
        initX0,
        ParNames
      );

      X0:=[];
      for i1 from 1 to nops(ParNames) do
         X0:=[op(X0),NewValues[i1]];
      end do;

    
    # 
    # substiture explicit functions intro anBVPSys
    #
      anBVPSys := Aux:-SystemClasses:-subsExplicitAEsIntoDAESys(anBVPSys);
     
    #
    # prepare interface for optimization
    #

      try:
        bvpopt:= createSharedObject(
          WorkingDir,
          anBVPSys,
          anNLP,
          X0,
          initP,
          nodes,
          objNames
        );
      catch:
	printf("CreateSharedObject failed, \n");
        printf("  error thrown was %q\n", lastexception);
        printf("  attempting to continue CreateInstance\n");
      end try; 


    #
    # create instance of simple wrapper
    #

      printf("creating instance of interface\n"); 
      
      try:
        BVPOptInstance:= NPSOL:-SubsIntoSimpleWrapper(
          anNLP, 
          bvpopt,
          WorkingDir,
          Scaling,
          'ScalingPars'
	);
      catch:
	printf("SubsIntoSimpleWrapper failed, \n");
        printf("  error thrown was %q\n", lastexception);
        printf("  attempting to continue CreateInstance\n");      
      end try;

      createOptionsFile(WorkingDir);
      

    RETURN(eval(BVPOptInstance));

  end proc; #CreateInstance






