######################################################################
#
#procedure SimpleTest2IntegrateAtSpecificTimePoints.txt
#
#description: Test if DDASPKSen works with variable input. 
#	      _EnvWorkingDir and _EnvModuleDir has to be set in the
#	      calling sheet. Numerical solution is compared to 
#	      analytical solution with variable input (with old package
#	      VariableInputSysIdent:-CreateODESolSenAnal()).
#
#input: none
#
#output: (1) boolean: true => test was succesful; false => test has failed
#	 (2) numerical integration solution (curve); for display in sheet.  
#	 (3) analytical integration solution (curve); for display in sheet.
#
#commet: needs the old collection of procedures VariableInputSysIdent.txt
#
#to do: (1) display does not work, output to file does not work. This
#	    is only a cosmetical problem.
#
#revision history:
#090109 changed directory names, so that they are unmistakable.
#	This has to be done to enable the removal of the folder
#	in the sheet in which it is called. Removal of the folder
#	at the end of this file does not work, since maple somehow
#	still has access to files in the folder. Error: 
#	.nfs000000000000365900000076': Device or resource busy. 
#	Only after restart one can remove the folder; tqu
#080904  created by tqu
#######################################################################

 SimpleTest2IntegrateAtSpecificTimePoints := proc()

  local 
   aDAESys,
   x1Data, 
   x2Data, 
   timePoints,
   test1Suceeded,
   test2Suceeded,
   actResults,
   initialVars,
   initialTime,
   DDASPKprocNum1,
   DDASPKprocNum2,
   DglSys,
   sol,	
   initConds0,
   pars0,
   sol0,
   tableOfSolution,
   tableOfDiffs,
   tableOfAnalyticalValues,
   parsNames,
   senName,
   p,
   actVar,
   parameter,
   actDiff,
   subsedDiff,
   subsedVar,
   allIndices,
   numResults,
   name,
   actNumValues,
   actAnalyticalValues,
   i,
   numValue,
   analyticalValue,
   analResults,
   inputTable,
   nrDataPoints,
   otherData,
   curveTest,
   DDASPKprocAnal1,
   DDASPKprocAnal2,
   DDASPKprocSysIdent,
   sysIdentResults,
   names,
   numError,
   numPlotOptions,
   entry,
   inputTest,
   correctnessCounter,
   errList,
   analDAESys,
   trueActInputPosition,
   actInputPosition;

   test1Suceeded := false;
   test2Suceeded := false;
   
  #
  #define simple test systen
  #
   aDAESys:=ModelPack:-NewDAESys():
   aDAESys[ODEs] := [
     `x1'` =a1*x1+input,
     `x2'` =a2*x2 +dummy
   ];
   aDAESys[Parameters] := [a1=-1, a2=-2, input=0, dummy=0];
   aDAESys[DynVars] := [x1, x2];
   aDAESys[AEs] := [];
   aDAESys[AlgVars] := [];
   initialVars:=[2,1];
   initialTime:=0;

  #
  #define simple test system for analytical test
  #
   analDAESys:=ModelPack:-NewDAESys():
   analDAESys[ODEs] := [
     `x1'` =a1*x1+input,
     `x2'` =a2*x2
   ];
   analDAESys[Parameters] := [a1=-1, a2=-2, input=0];
   analDAESys[DynVars] := [x1, x2];
   analDAESys[AEs] := [];
   analDAESys[AlgVars] := [];
   initialVars:=[2,1];
   initialTime:=0;
  
  #
  #check if aDAESys is correctly defined
  #
   errList:= ModelPack:-ListOfErrorsInDAESys(aDAESys);
   if not
     errList=[]     
   then
     error(cat(" DAESys is not defined correctly. The following error/s occured ", convert(errList, string)));
   end if:

  #
  #check if aDAESys is correctly defined
  #
   errList:= ModelPack:-ListOfErrorsInDAESys(analDAESys);
   if not
     errList=[]     
   then
     error(cat(" DAESys for analyt.test is not defined correctly. The following error/s occured ", convert(errList, string)));
   end if:


  #
  #ckeck if three directories (SimpleTest2IntegrateAtSpecificTimePointsTmp1, SimpleTest2IntegrateAtSpecificTimePointsTmp2, 
  #SimpleTest2IntegrateAtSpecificTimePointsTmp3,SimpleTest2IntegrateAtSpecificTimePointsTmp4) needed for calculation already exists
  #	
   if
     ModelPack:-DirExists("SimpleTest2IntegrateAtSpecificTimePointsTmp1") or ModelPack:-DirExists("SimpleTest2IntegrateAtSpecificTimePointsTmp2") 
     or ModelPack:-DirExists("SimpleTest2IntegrateAtSpecificTimePointsTmp3") or ModelPack:-DirExists("SimpleTest2IntegrateAtSpecificTimePointsTmp4") 
   then
     error("temporary directory ./SimpleTest2IntegrateAtSpecificTimePointsTmp1, ./SimpleTest2IntegrateAtSpecificTimePointsTmp2, ./SimpleTest2IntegrateAtSpecificTimePointsTmp3, /SimpleTest2IntegrateAtSpecificTimePointsTmp4  needed to run test already exists")
   else  
       mkdir("SimpleTest2IntegrateAtSpecificTimePointsTmp1"); 
       mkdir("SimpleTest2IntegrateAtSpecificTimePointsTmp2"); 
       mkdir("SimpleTest2IntegrateAtSpecificTimePointsTmp3");
       mkdir("SimpleTest2IntegrateAtSpecificTimePointsTmp4");
   end if;

  #--------------------------------------------------------------------------------
  #
  #test1: compare analytical with numerical solution
  #
  #--------------------------------------------------------------------------------

   #
   #create instance of DDASPKsen for numerical solution
   #
    DDASPKprocNum1 := DDASPKSen:-CreateInstance(aDAESys, "./SimpleTest2IntegrateAtSpecificTimePointsTmp1", [a1, a2], 'adifor'):

   #	      
   #set initial values, initial time, and parameter values and initialize DDASPKproc
   #
    DDASPKprocNum1 :-SetVars(initialVars);
    DDASPKprocNum1:-SetInitialTime(initialTime);

   #	
   #define the input Curve for the test1
   # 
    inputTest:= [[2,7],[2.5,-1],[3,3],[3.3,0],[4,2],[10,100]];
    trueActInputPosition:= nops(inputTest);
    inputTable:=table();
    inputTable[time]:=array([seq(inputTest[i,1], i=1..nops(inputTest))]);
    inputTable[input]:=array([seq(inputTest[i,2], i=1..nops(inputTest))]);
    nrDataPoints:= nops(convert(
     eval(inputTable[time]), 
      list)
    );
    otherData := ['NumPoints'= nrDataPoints, Parameters= [], SpecialVarNames=[]];
    curveTest := ModelPack:-CreateCurve(inputTable,otherData);
   
   #
   #set input
   #
   DDASPKprocNum1:-SetInput(curveTest);

   #
   #create Results with IntegrateAtSpecificTimePoints.txt
   # 
    timePoints:= [seq(i, i=0..5,0.1)];
    numResults:= DDASPKprocNum1:-IntegrateAtSpecificTimePoints(timePoints[2..-1]);
    actInputPosition:= DDASPKprocNum1:-GetActInputPosition();
    if not
      actInputPosition = trueActInputPosition
    then
      error("setting of ActInputPosition failed");
    end if:

   #
   #calculate Analytical solution
   #
     DDASPKprocAnal1 := DDASPKSen:-CreateInstance(analDAESys, "./SimpleTest2IntegrateAtSpecificTimePointsTmp2", [a1, a2], 'adifor'):
     analResults:= SysIdent:-CreateODESolSenAnal(DDASPKprocAnal1,
       500,	 #DDASPKSen repeats
       5,		 #endTime
       0.1,	 #intervalTime
       initialTime,#initTime
       initialVars, 
       inputTest);
     analResults:= analResults[1];  

  #
  #do comparison of all values between analytical and numerical results.
  #   
   allIndices:= indices(eval(numResults:-GetData()));
   allIndices:=map(op,[allIndices]);
   timePoints:= convert(numResults:-GetAllValuesOfVariable(time),list);

   correctnessCounter:=0;
   for names in allIndices do:
     actNumValues:= numResults:-GetAllValuesOfVariable(names);
     actAnalyticalValues:= analResults:-GetAllValuesOfVariable(names);

     for i from 1 to nops(timePoints)do:
       numValue:= actNumValues[i];
       analyticalValue:= actAnalyticalValues[i];
       numError:=abs(numValue - analyticalValue);
       if
	 (numError <= 0.0001) 
       then
	  correctnessCounter:= correctnessCounter +1;
       else
	 print("Warning(Test1): failed", numValue, analyticalValue);
       end if;
     end do:

   end do:
  
  #
  #check if test1 suceeded
  # 
   if
     correctnessCounter = ( nops(allIndices)*nops(timePoints) )
   then
     test1Suceeded:=true;
   end if:

  #--------------------------------------------------------------------------------
  #
  #test2: test if input at time points different to integration times is calculated
  #	  correctly. Numerical results with interval 1 calculated, whereas
  #	  analytical result is calculated with interval 0.1 => if at points at
  #	  [seq(i,i=1..5)], the values are equal, even when input times not at 
  #	  integer timepoints the test has suceeded.
  #
  #--------------------------------------------------------------------------------

    #
    #create instance of DDASPKsen
    #
     DDASPKprocNum2 := DDASPKSen:-CreateInstance(aDAESys, "./SimpleTest2IntegrateAtSpecificTimePointsTmp3", [a1, a2], 'adifor'):

    #	      
    #set initial values, initial time, and parameter values and initialize DDASPKproc
    #
     DDASPKprocNum2 :-SetVars(initialVars);
     DDASPKprocNum2:-SetInitialTime(initialTime);
     DDASPKprocNum2:-Init();

    #
    #set input
    #
    DDASPKprocNum2:-SetInput(curveTest);  

    #
    #create Results with IntegrateAtSpecificTimePoints.txt
    # 
     timePoints:= [seq(i, i=0..5,1)];
     numResults:= DDASPKprocNum2:-IntegrateAtSpecificTimePoints(timePoints[2..-1]);

    #
    #calculate Analytical solution
    #
      DDASPKprocAnal2 := DDASPKSen:-CreateInstance(analDAESys, "./SimpleTest2IntegrateAtSpecificTimePointsTmp4", [a1, a2], 'adifor'):
      analResults:= SysIdent:-CreateODESolSenAnal(DDASPKprocAnal2,
	500,	 #DDASPKSen repeats
	5,		 #endTime
	0.1,	 #intervalTime
	initialTime,#initTime
	initialVars, 
	inputTest
      );
      analResults:= analResults[1];  

     allIndices:= indices(eval(numResults:-GetData()));
     allIndices:=map(op,[allIndices]);
     timePoints:= convert(numResults:-GetAllValuesOfVariable(time),list);
     
     correctnessCounter:=0;
     for names in allIndices do:
       actNumValues:= numResults:-GetAllValuesOfVariable(names);
       actAnalyticalValues:= analResults:-GetAllValuesOfVariable(names);
     
       for i from 1 to nops(timePoints)do:
	 numValue:= actNumValues[i];
	 analyticalValue:= actAnalyticalValues[1+(i-1)*10];
	 numError:=abs(numValue - analyticalValue);
	 if
	   (numError <= 0.0001) 
	 then
	   correctnessCounter := correctnessCounter +1;
	 else  	 
	   print("Warning(Test2): failed", numValue, analyticalValue);
	 end if;
       end do:

     end do:

  #
  #check if test2 suceeded
  # 
   if
     correctnessCounter = ( nops(allIndices)*nops(timePoints) )
   then
     test2Suceeded:=true;
   end if:


  #clean up created tmp-directories
  
#   try:
#     system("rm -r SimpleTest2IntegrateAtSpecificTimePointsTmp1");
#     system("rm -r SimpleTest2IntegrateAtSpecificTimePointsTmp2");
#     system("rm -r SimpleTest2IntegrateAtSpecificTimePointsTmp3");
#     system("rm -r SimpleTest2IntegrateAtSpecificTimePointsTmp4");
#   end:

  return(evalb(test1Suceeded and test2Suceeded),numResults, analResults);
    
end proc; #SimpleTest2IntegrateAtSpecificTimePoints